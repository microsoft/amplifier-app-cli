name: "agent-delegation"
description: "Phase 1 Feature Test: Sub-session spawning via task tool (agent delegation)"
version: "1.0.0"
author: "Amplifier Recipes Team"
created: "2025-12-10T15:48:00Z"
tags: ["phase-1", "cli", "agent-delegation", "task-tool", "sub-session", "feature-test"]

# Test context
context:
  test_word: "testing"
  expected_count: 7

# Test Steps
steps:
  # Step 1: Delegate task to sub-agent
  # The explorer agent will use the task tool to spawn a sub-agent
  # that counts letters in the word "testing"
  - id: "delegate-task"
    agent: "foundation:explorer"
    timeout: 60
    prompt: |
      Use the task tool to delegate this counting task to a sub-agent:
      
      "Count the number of letters in the word '{{test_word}}'"
      
      The sub-agent should analyze the word and return the exact count.
      Expected result: {{expected_count}} letters
      
      After the sub-agent completes, capture its response in your output.
    output: "delegation_result"
    retry:
      max_attempts: 2
      backoff: "exponential"
      initial_delay: 5

  # Step 2: Validate delegation behavior
  # The result-validator checks that the delegation mechanism worked correctly
  - id: "validate"
    agent: "result-validator"
    timeout: 60
    prompt: |
      Validate the agent delegation test results:
      
      TEST: Agent Delegation via Task Tool
      
      Delegation Result:
      {{delegation_result}}
      
      VALIDATION CRITERIA (all must pass):
      
      1. Task Tool Invocation
         - Verify the parent agent (foundation:explorer) successfully invoked the task tool
         - Evidence: delegation_result should contain task tool usage
      
      2. Sub-Agent Session Spawned
         - Verify a sub-agent session was created
         - Evidence: delegation_result should show sub-agent activity
      
      3. Correct Answer Produced
         - Verify sub-agent counted letters in "{{test_word}}" correctly
         - Expected: {{expected_count}} letters
         - Evidence: delegation_result should contain the number {{expected_count}}
      
      4. Result Returned to Parent
         - Verify the sub-agent's answer flowed back to the parent agent
         - Evidence: delegation_result contains sub-agent's complete response
      
      VERDICT FORMAT:
      - Start with "PASS:" if all criteria met
      - Start with "FAIL:" if any criteria failed
      - Provide evidence for each criterion
      - List which criteria passed/failed
      
      What we're testing:
      - CLI spawns sub-sessions correctly
      - Task tool integration works end-to-end
      - Parent-child session communication works
      - Results flow back properly from sub-agent to parent
    output: "validation_verdict"
    on_error: "fail"

# Recipe Usage:
#
# Execute test:
#   amplifier recipes execute amplifier-app-cli/tests/recipes/features/agent-delegation.yaml
#
# Expected behavior:
#   - Step 1: foundation:explorer delegates counting task to sub-agent
#   - Sub-agent counts 7 letters in "testing"
#   - Result flows back to parent agent
#   - Step 2: result-validator verifies all delegation mechanisms worked
#   - Final verdict: PASS or FAIL
#
# Success criteria:
#   - validation_verdict starts with "PASS:"
#   - All 4 validation criteria met
#   - Sub-agent correctly identified 7 letters
#
# This test validates core CLI capability:
#   Agent delegation via task tool sub-session spawning
